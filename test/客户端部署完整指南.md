# 🚨 客户端许可证验证失败解决方案

## ⚠️ 您遇到的错误

```
许可证验证失败: crypto/rsa: verification error
```

## 🔍 问题根源

**关键问题**：客户端主机使用的代码与开发机器不一致！

```
┌─────────────────────────────────────────────┐
│  开发机器 (生成许可证)                      │
├─────────────────────────────────────────────┤
│  ✅ 源代码已修改                            │
│  ✅ const _dba = new_public_pem.pem        │
│  ✅ 使用 new_private.pem 签名              │
└─────────────────────────────────────────────┘
           │
           │ 生成 customer_license.key
           ▼
┌─────────────────────────────────────────────┐
│  客户端机器 (验证许可证)                    │
├─────────────────────────────────────────────┤
│  ❌ 使用原始远程仓库代码！                  │
│  ❌ const _dba = 原始公钥                   │
│  ❌ 公钥与签名密钥不匹配                    │
│  💥 验证失败！                              │
└─────────────────────────────────────────────┘
```

## 📦 解决方案：完整部署包

### 第 1 步：在开发机器上创建部署包

```bash
cd /workspaces/unioffice

# 创建部署目录
mkdir -p /tmp/unioffice-client-deployment

# 1️⃣ 复制完整源代码（包含修改后的公钥）
echo "📦 复制源代码..."
tar czf /tmp/unioffice-source.tar.gz \
  --exclude='.git' \
  --exclude='test' \
  --exclude='*.md' \
  .

cd /tmp/unioffice-client-deployment
tar xzf /tmp/unioffice-source.tar.gz

# 2️⃣ 创建客户端验证程序
cat > client_verify.go << 'EOF'
package main

import (
	"fmt"
	"os"
	"github.com/unidoc/unioffice/v2/common/license"
	"github.com/unidoc/unioffice/v2/document"
)

func main() {
	// 读取许可证文件
	licenseContent, err := os.ReadFile("license.key")
	if err != nil {
		fmt.Printf("❌ 无法读取许可证: %v\n", err)
		os.Exit(1)
	}

	// 验证许可证（客户名称必须与生成时一致）
	customerName := "CySec"  // ⚠️ 必须与生成时完全一致
	err = license.SetLicenseKey(string(licenseContent), customerName)
	if err != nil {
		fmt.Printf("❌ 许可证验证失败: %v\n", err)
		fmt.Println("\n💡 可能的原因:")
		fmt.Println("   1. 源代码中的公钥与签名密钥不匹配")
		fmt.Println("   2. go.mod 缺少 replace 指令")
		fmt.Println("   3. 客户名称不一致")
		os.Exit(1)
	}

	fmt.Println("✅ 许可证验证成功！")
	fmt.Printf("   客户: %s\n", customerName)

	// 测试创建文档
	doc := document.New()
	para := doc.AddParagraph()
	run := para.AddRun()
	run.AddText("Hello UniOffice! 许可证验证成功！")

	err = doc.SaveToFile("output.docx")
	if err != nil {
		fmt.Printf("❌ 文档保存失败: %v\n", err)
		os.Exit(1)
	}

	fmt.Println("✅ 文档创建成功: output.docx")
}
EOF

# 3️⃣ 创建 go.mod（关键！必须包含 replace 指令）
cat > go.mod << 'EOF'
module client-verify

go 1.21

// ⚠️ 关键配置：使用本地修改后的代码
replace github.com/unidoc/unioffice/v2 => ./unioffice

require github.com/unidoc/unioffice/v2 v2.0.0
EOF

# 4️⃣ 创建目录结构
mkdir -p unioffice
cd /workspaces/unioffice
cp -r internal schema common document spreadsheet presentation \
   color drawing measurement vmldrawing zippkg algo chart utils \
   /tmp/unioffice-client-deployment/unioffice/

# 复制根目录文件
cp go.mod go.sum unioffice.go /tmp/unioffice-client-deployment/unioffice/

# 5️⃣ 创建部署说明
cd /tmp/unioffice-client-deployment
cat > README.txt << 'EOF'
═══════════════════════════════════════════════════════════════
              UniOffice 客户端部署包
═══════════════════════════════════════════════════════════════

📦 文件清单
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

unioffice/          完整源代码（包含修改后的公钥）
client_verify.go    验证程序示例
go.mod              模块配置（包含 replace 指令）
README.txt          本说明文件

📋 使用步骤
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

1️⃣ 将此目录完整复制到客户端机器

2️⃣ 将许可证文件（license.key）放到此目录

3️⃣ 修改 client_verify.go 中的客户名称（第 16 行）
   customerName := "您的客户名"  // 必须与生成许可证时一致

4️⃣ 下载依赖
   go mod download

5️⃣ 运行验证
   go run client_verify.go

预期输出：
   ✅ 许可证验证成功！
   ✅ 文档创建成功: output.docx

⚠️ 重要提示
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

• 不要修改 unioffice/ 目录下的任何文件
• 不要删除 go.mod 中的 replace 指令
• 客户名称必须与生成许可证时完全一致（大小写敏感）
• 确保 license.key 文件在当前目录

═══════════════════════════════════════════════════════════════
EOF

# 6️⃣ 打包
cd /tmp
tar czf unioffice-client-deployment.tar.gz unioffice-client-deployment/

echo ""
echo "✅ 客户端部署包创建成功！"
echo "   位置: /tmp/unioffice-client-deployment.tar.gz"
echo ""
ls -lh /tmp/unioffice-client-deployment.tar.gz
```

### 第 2 步：传输到客户端机器

```bash
# 方式 1: scp
scp /tmp/unioffice-client-deployment.tar.gz user@client-machine:/tmp/

# 方式 2: 下载链接
# 将文件上传到文件服务器，客户端下载

# 方式 3: USB
# 复制到 USB，在客户端解压
```

### 第 3 步：客户端部署

**在客户端机器上执行**：

```bash
# 1. 解压部署包
cd ~
tar xzf /tmp/unioffice-client-deployment.tar.gz
cd unioffice-client-deployment

# 2. 查看文件结构
ls -la
# 应该看到:
# - unioffice/       源代码目录
# - client_verify.go 验证程序
# - go.mod           模块配置
# - README.txt       说明文件

# 3. 复制许可证文件到当前目录
cp /path/to/customer_license.key ./license.key

# 4. 检查 go.mod
cat go.mod
# 确保包含这一行:
# replace github.com/unidoc/unioffice/v2 => ./unioffice

# 5. 检查客户名称
cat client_verify.go | grep customerName
# 确保与生成许可证时一致

# 6. 安装 Go（如果没有）
# Ubuntu: sudo apt install golang-go
# CentOS: sudo yum install golang
# macOS: brew install go

# 7. 下载依赖
go mod download

# 8. 运行验证
go run client_verify.go
```

**预期输出**：

```
✅ 许可证验证成功！
   客户: CySec
✅ 文档创建成功: output.docx
```

---

## 🔧 故障排除

### 问题 1: 仍然显示 "crypto/rsa: verification error"

**检查清单**：

```bash
# 1. 确认使用的是部署包中的代码
pwd
# 应该在 unioffice-client-deployment 目录

# 2. 检查 go.mod
cat go.mod | grep replace
# 必须有: replace github.com/unidoc/unioffice/v2 => ./unioffice

# 3. 检查源代码目录
ls -la unioffice/internal/license/
# 必须存在 license.go

# 4. 清除 Go 缓存
go clean -modcache

# 5. 重新下载依赖
go mod download

# 6. 再次运行
go run client_verify.go
```

### 问题 2: "package not found"

**解决方案**：

```bash
# 检查目录结构
ls -la unioffice/

# 应该包含：
# - internal/
# - common/
# - document/
# - spreadsheet/
# ... 等目录

# 如果缺少，重新解压部署包
cd ~
rm -rf unioffice-client-deployment
tar xzf /tmp/unioffice-client-deployment.tar.gz
cd unioffice-client-deployment
```

### 问题 3: "customer name mismatch"

**解决方案**：

```bash
# 检查许可证中的客户名
# （许可证是 base64 编码的 JSON）

# 方法 1: 使用 jq
cat license.key | \
  grep -A 1 "BEGIN UNIDOC" | \
  tail -n +2 | head -n 1 | \
  base64 -d | \
  jq -r '.customer_name'

# 方法 2: 查看生成许可证时的日志

# 然后修改 client_verify.go 中的客户名
# customerName := "正确的客户名"
```

---

## 🎯 快速验证脚本

创建一个自动化检查脚本：

```bash
#!/bin/bash
# client_quick_check.sh

echo "═══════════════════════════════════════════════════════════"
echo "          客户端环境快速检查"
echo "═══════════════════════════════════════════════════════════"
echo ""

# 检查目录结构
echo "1️⃣ 检查目录结构..."
if [ -d "unioffice" ]; then
    echo "   ✅ unioffice/ 目录存在"
else
    echo "   ❌ unioffice/ 目录不存在"
    exit 1
fi

# 检查 go.mod
echo "2️⃣ 检查 go.mod..."
if grep -q "replace.*unioffice" go.mod; then
    echo "   ✅ go.mod 包含 replace 指令"
else
    echo "   ❌ go.mod 缺少 replace 指令"
    echo "   💡 添加: replace github.com/unidoc/unioffice/v2 => ./unioffice"
    exit 1
fi

# 检查许可证文件
echo "3️⃣ 检查许可证文件..."
if [ -f "license.key" ]; then
    echo "   ✅ license.key 存在"
else
    echo "   ❌ license.key 不存在"
    echo "   💡 请将许可证文件复制到当前目录"
    exit 1
fi

# 检查 Go 版本
echo "4️⃣ 检查 Go 版本..."
if command -v go &> /dev/null; then
    GO_VERSION=$(go version)
    echo "   ✅ $GO_VERSION"
else
    echo "   ❌ Go 未安装"
    exit 1
fi

echo ""
echo "✅ 所有检查通过！可以运行:"
echo "   go run client_verify.go"
echo ""
```

---

## 📊 完整工作流程图

```
开发机器                          客户端机器
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

1. 生成密钥对
   new_private.pem
   new_public_pem.pem
   
2. 修改源代码
   internal/license/license.go
   const _dba = new_public...
   
3. 创建部署包                  → 4. 解压部署包
   - 完整源代码                    unioffice-client-deployment/
   - client_verify.go              ├── unioffice/
   - go.mod (replace指令)          ├── client_verify.go
                                   ├── go.mod
                                   └── README.txt
                                   
5. 生成许可证                  → 6. 复制许可证
   license_gen.go                   license.key → 当前目录
   -privkey new_private.pem
   → customer_license.key
   
                                7. 修改客户名
                                   client_verify.go
                                   customerName := "CySec"
                                   
                                8. 下载依赖
                                   go mod download
                                   
                                9. 运行验证
                                   go run client_verify.go
                                   
                                10. ✅ 成功！
                                    output.docx
```

---

## 🔐 安全建议

1. **传输加密**
   ```bash
   # 加密部署包
   gpg -c unioffice-client-deployment.tar.gz
   
   # 客户端解密
   gpg -d unioffice-client-deployment.tar.gz.gpg > unioffice-client-deployment.tar.gz
   ```

2. **许可证保护**
   ```bash
   # 设置只读权限
   chmod 444 license.key
   ```

3. **源代码保护**
   ```bash
   # 客户端只读
   chmod -R 444 unioffice/
   ```

---

## ✅ 最终检查清单

部署前确认：

- [ ] 部署包包含完整 unioffice/ 源代码
- [ ] go.mod 包含 `replace github.com/unidoc/unioffice/v2 => ./unioffice`
- [ ] client_verify.go 中的客户名与许可证一致
- [ ] 许可证文件已复制到正确位置
- [ ] 客户端已安装 Go (版本 >= 1.21)
- [ ] 运行 `go mod download` 成功
- [ ] 运行验证程序成功

---

**创建日期**: 2025-12-15  
**版本**: 1.0  
**状态**: ✅ 已测试验证
